{% extends "base.html" %}
{% load staticfiles%}

{% block extrahead %}
<script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src='http://maps.google.com/maps/api/js?sensor=false&libraries=places'></script>
<script type="text/javascript" src='{% static "js/location_picker.js" %}'></script>

<script type="text/javascript">
function getLocation() {
	let getLatLong = function (location) {
		return [location.coords.latitude, location.coords.longitude];
    }

    return new Promise(function(resolve, reject) {
      if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (x) {
          	resolve(getLatLong(x));
          });
      } else {
          reject(Error('Geolocation not supported!'));
      }
    });
}

function showMap(latitude, longitude, radius) {
	$('#locationpicker').locationpicker({
	    location: {
		    latitude: latitude,
	        longitude: longitude
	    },
	    radius: radius,
	    markerInCenter: true,
	    zoom: 12,
	    enableAutocomplete: true,
	    onchanged: function (currentLocation, radius, isMarkerDropped) {
        	console.log("Location changed. New location (" + currentLocation.latitude + ", " + currentLocation.longitude + ")");
    		user_lat.value = currentLocation.latitude;
    		user_long.value = currentLocation.longitude;
    	}
	});
}

function refreshMap() {
	let lat = parseFloat(user_lat.value);
	let long = parseFloat(user_long.value);
	let radius = user_radius.value;
	showMap(lat,long,radius);
}

window.onload = function () {
	showMap(28.6562,77.2410,5000);

	getLocation().then(function (res){
		user_lat.value = res[0];
		user_long.value = res[1];
		showMap(res[0], res[1], 5000);
	}, function (_) {
		alert('Geolocation not supported in your browser!');
	});
}
</script>
{% endblock %}

{% block content %}
<form action="{% url "resto:search" %}" method="GET">
	<input id="user_lat" type="text" name="user_lat" placeholder="28.6562" style="display: none" />
	<input id="user_long" type="text" name="user_long" placeholder="77.2410" style="display: none" />
    <input id="user_radius" type="range" name="user_radius" min="5000" max="50000" value="5000" style="width:200px;" onchange="refreshMap()" />
    <input id="user_veg_only" type="checkbox" value="veg_only" name="user_veg_only" />
    <label for="user_veg_only">Veg Only?</label>
    <button type="submit">Search</button>
</form>

<div id="locationpicker" style="width: 100%; height: 400px;"></div>
{% endblock %}